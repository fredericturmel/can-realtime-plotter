name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            src/**/*.py
            tests/**/*.py
            
      - name: AI-Powered Review with OpenAI
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: anc95/ChatGPT-CodeReview@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          model: gpt-4
          temperature: 0.2
          max_tokens: 3000
          review_comment_lgtm: false
          language: fr
          prompt: |
            Tu es un expert Python senior charg√© de faire une revue de code EXHAUSTIVE et EXIGEANTE.
            
            MISSION: Analyser ce code avec un niveau d'exigence MAXIMUM et identifier TOUS les probl√®mes.
            
            CRIT√àRES D'ANALYSE (par ordre de priorit√©):
            
            1. S√âCURIT√â (CRITIQUE):
               - Injections (SQL, commande, path traversal)
               - Validation des entr√©es utilisateur
               - Gestion des secrets et credentials
               - Vuln√©rabilit√©s connues (CVE)
               
            2. BUGS POTENTIELS (CRITIQUE):
               - Conditions de course
               - Fuites m√©moire
               - Gestion d'erreurs manquante
               - Edge cases non g√©r√©s
               - None/null pointer issues
               
            3. PERFORMANCE (HAUTE):
               - Complexit√© algorithmique O(n¬≤) ou pire
               - Fuites de ressources (fichiers, connexions)
               - Inefficacit√© √©vidente (N+1 queries)
               - Blocages UI dans le thread principal
               
            4. ARCHITECTURE (HAUTE):
               - Violations SOLID
               - Couplage fort
               - Duplication de code
               - Responsabilit√©s mal d√©finies
               - D√©pendances circulaires
               
            5. QUALIT√â DU CODE (MOYENNE):
               - Complexit√© cyclomatique > 10
               - Fonctions/classes trop longues (>50 lignes fonction, >500 lignes classe)
               - Nommage confus ou non explicite
               - Magic numbers/strings
               
            6. MAINTENABILIT√â (MOYENNE):
               - Documentation manquante ou obsol√®te
               - Tests unitaires absents
               - Type hints manquants
               - Commentaires peu clairs
               
            7. BONNES PRATIQUES PYTHON (BASSE):
               - PEP 8 violations
               - Idiomes Python non utilis√©s
               - Imports non optimis√©s
               
            FORMAT DE R√âPONSE EXIG√â:
            
            Pour chaque probl√®me trouv√©:
            
            üö® [S√âV√âRIT√â] Titre court
            üìç Fichier:ligne
            ‚ùå Probl√®me: Description d√©taill√©e
            üí° Solution: Code sugg√©r√© ou explication
            üéØ Impact: Cons√©quence si non corrig√©
            
            S√©v√©rit√©s:
            - üî¥ CRITIQUE: Bug, s√©curit√©, corruption de donn√©es
            - üü† HAUTE: Performance, architecture, maintenabilit√©
            - üü° MOYENNE: Qualit√©, lisibilit√©, conventions
            - üîµ BASSE: Optimisations mineures, style
            
            EXIGENCES SUPPL√âMENTAIRES:
            - √ätre TR√àS STRICT et ne rien laisser passer
            - Proposer des solutions CONCR√àTES avec du code
            - Expliquer le POURQUOI, pas juste le QUOI
            - Prioriser par s√©v√©rit√© d√©croissante
            - Si le code est parfait (rare!), l'indiquer clairement
            
            NE PAS:
            - √ätre poli ou m√©nager l'ego
            - Accepter du code "assez bon"
            - Ignorer les probl√®mes mineurs
            - Faire des suggestions vagues
            
            OBJECTIVE: Code de qualit√© PRODUCTION avec z√©ro compromis.
