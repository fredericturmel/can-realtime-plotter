name: Quality Check & Auto-Improvement

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Exécution quotidienne à 2h du matin pour vérification proactive
    - cron: '0 2 * * *'

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pylint flake8 black mypy bandit safety
          
      - name: Code formatting check (Black)
        run: |
          black --check --diff src/ tests/
        continue-on-error: true
        
      - name: Linting (Pylint)
        run: |
          pylint src/ --exit-zero --output-format=json > pylint-report.json
          
      - name: Style check (Flake8)
        run: |
          flake8 src/ tests/ --max-line-length=120 --statistics > flake8-report.txt
        continue-on-error: true
        
      - name: Type checking (MyPy)
        run: |
          mypy src/ --ignore-missing-imports --no-error-summary > mypy-report.txt
        continue-on-error: true
        
      - name: Security check (Bandit)
        run: |
          bandit -r src/ -f json -o bandit-report.json
        continue-on-error: true
        
      - name: Dependency vulnerability check
        run: |
          safety check --json > safety-report.json
        continue-on-error: true
        
      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports
          path: |
            pylint-report.json
            flake8-report.txt
            mypy-report.txt
            bandit-report.json
            safety-report.json
            
  automated-testing:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist
          
      - name: Run unit tests with coverage
        run: |
          pytest tests/ --cov=src --cov-report=xml --cov-report=html -n auto
        continue-on-error: true
        
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          
  create-improvement-issues:
    runs-on: ubuntu-latest
    needs: [code-quality, automated-testing]
    if: github.event_name == 'schedule' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      
      - name: Download quality reports
        uses: actions/download-artifact@v4
        with:
          name: quality-reports
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Analyze reports and create issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/analyze_and_create_issues.py
          
  ai-code-review:
    runs-on: ubuntu-latest
    needs: [code-quality]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: AI-powered code review
        uses: anc95/ChatGPT-CodeReview@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          model: gpt-4
          temperature: 0.3
          top_p: 1
          max_tokens: 2000
