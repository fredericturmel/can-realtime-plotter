#!/usr/bin/env python3
"""
Pre-commit hook pour validation automatique avant chaque commit.
Installe avec: python .github/scripts/install_hooks.py
"""

import subprocess
import sys
import os


def run_command(cmd: list, description: str) -> bool:
    """Ex√©cute une commande et retourne True si succ√®s"""
    print(f"\nüîç {description}...")
    
    try:
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=60
        )
        
        if result.returncode == 0:
            print(f"‚úÖ {description} - OK")
            return True
        else:
            print(f"‚ùå {description} - √âCHEC")
            print(result.stdout)
            print(result.stderr)
            return False
            
    except subprocess.TimeoutExpired:
        print(f"‚è±Ô∏è {description} - TIMEOUT")
        return False
    except Exception as e:
        print(f"‚ùå {description} - ERREUR: {e}")
        return False


def check_code_formatting() -> bool:
    """V√©rifie le formatage du code"""
    return run_command(
        ['black', '--check', 'src/', 'tests/'],
        "V√©rification formatage (Black)"
    )


def check_code_style() -> bool:
    """V√©rifie le style du code"""
    return run_command(
        ['flake8', 'src/', 'tests/', '--max-line-length=120', '--max-complexity=10'],
        "V√©rification style (Flake8)"
    )


def check_type_hints() -> bool:
    """V√©rifie les type hints"""
    result = run_command(
        ['mypy', 'src/', '--ignore-missing-imports'],
        "V√©rification types (MyPy)"
    )
    # MyPy peut retourner des warnings, on continue quand m√™me
    return True


def check_security() -> bool:
    """V√©rifie la s√©curit√©"""
    return run_command(
        ['bandit', '-r', 'src/', '-ll'],  # Low level warnings
        "V√©rification s√©curit√© (Bandit)"
    )


def run_unit_tests() -> bool:
    """Ex√©cute les tests unitaires"""
    return run_command(
        ['pytest', 'tests/', '-v', '--tb=short'],
        "Ex√©cution tests unitaires"
    )


def check_imports() -> bool:
    """V√©rifie l'ordre des imports"""
    return run_command(
        ['isort', '--check-only', 'src/', 'tests/'],
        "V√©rification imports (isort)"
    )


def main() -> int:
    """Point d'entr√©e principal"""
    print("="*80)
    print("PRE-COMMIT VALIDATION")
    print("="*80)
    
    checks = [
        ("Formatage", check_code_formatting),
        ("Style", check_code_style),
        ("Types", check_type_hints),
        ("S√©curit√©", check_security),
        ("Imports", check_imports),
        ("Tests", run_unit_tests),
    ]
    
    results = {}
    for name, check_func in checks:
        results[name] = check_func()
        
    # R√©sum√©
    print("\n" + "="*80)
    print("R√âSUM√â")
    print("="*80)
    
    for name, passed in results.items():
        status = "‚úÖ" if passed else "‚ùå"
        print(f"{status} {name}")
        
    # D√©terminer si on peut commit
    critical_checks = ["Formatage", "Style", "S√©curit√©", "Tests"]
    critical_failed = [name for name in critical_checks if not results.get(name, False)]
    
    if critical_failed:
        print(f"\n‚ùå COMMIT BLOQU√â - V√©rifications critiques √©chou√©es: {', '.join(critical_failed)}")
        print("\nüí° Commandes pour corriger:")
        if "Formatage" in critical_failed:
            print("   black src/ tests/")
        if "Style" in critical_failed:
            print("   Corriger les erreurs Flake8 manuellement")
        if "Imports" in critical_failed:
            print("   isort src/ tests/")
        if "Tests" in critical_failed:
            print("   Corriger les tests qui √©chouent")
            
        return 1
    else:
        print("\n‚úÖ TOUTES LES V√âRIFICATIONS PASS√âES - Commit autoris√©")
        return 0


if __name__ == '__main__':
    sys.exit(main())
